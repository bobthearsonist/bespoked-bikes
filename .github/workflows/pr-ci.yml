name: PR CI/CD Pipeline

on:
  pull_request:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  # ============================================
  # Backend Jobs
  # ============================================

  backend-unit-tests:
    name: Backend ‚Üí Unit Tests
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET Backend
        uses: ./.github/actions/setup-dotnet-backend

      - name: Run unit tests
        uses: ./.github/actions/run-backend-tests
        with:
          test-project: 'BespokedBikes.Tests.Unit'
          coverage: 'true'

      - name: Generate coverage summary
        id: coverage
        run: |
          cd apps/backend/TestResults
          COVERAGE_FILE=$(find . -name "coverage.cobertura.xml" | head -1)
          if [ -f "$COVERAGE_FILE" ]; then
            LINE_RATE=$(grep -oP 'line-rate="\K[^"]+' "$COVERAGE_FILE" | head -1)
            PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", $LINE_RATE * 100}")
            echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
            echo "Backend unit test coverage: $PERCENTAGE%"
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "No coverage data found"
          fi

      - name: Upload coverage to Codecov
        uses: ./.github/actions/upload-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          coverage-file: 'apps/backend/TestResults/**/coverage.cobertura.xml'
          flags: 'backend-unit'
          artifact-name: 'backend-unit-coverage'
          artifact-path: 'apps/backend/TestResults/**/coverage.cobertura.xml'

  backend-integration-tests:
    name: Backend ‚Üí Integration Tests
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET Backend
        uses: ./.github/actions/setup-dotnet-backend

      - name: Run integration tests
        uses: ./.github/actions/run-backend-tests
        with:
          test-project: 'BespokedBikes.Tests.Integration'
          coverage: 'true'

      - name: Generate coverage summary
        id: coverage
        run: |
          cd apps/backend/TestResults
          COVERAGE_FILE=$(find . -name "coverage.cobertura.xml" | head -1)
          if [ -f "$COVERAGE_FILE" ]; then
            LINE_RATE=$(grep -oP 'line-rate="\K[^"]+' "$COVERAGE_FILE" | head -1)
            PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", $LINE_RATE * 100}")
            echo "percentage=$PERCENTAGE" >> $GITHUB_OUTPUT
            echo "Backend integration test coverage: $PERCENTAGE%"
          else
            echo "percentage=0" >> $GITHUB_OUTPUT
            echo "No coverage data found"
          fi

      - name: Upload coverage to Codecov
        uses: ./.github/actions/upload-coverage
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          coverage-file: 'apps/backend/TestResults/**/coverage.cobertura.xml'
          flags: 'backend-integration'
          artifact-name: 'backend-integration-coverage'
          artifact-path: 'apps/backend/TestResults/**/coverage.cobertura.xml'

  # ============================================
  # Frontend Jobs (Placeholders)
  # ============================================

  frontend-unit-tests:
    name: Frontend ‚Üí Unit Tests
    runs-on: ubuntu-latest
    outputs:
      coverage: ${{ steps.coverage.outputs.percentage }}
    steps:
      - name: Placeholder
        id: coverage
        run: |
          echo "Frontend unit tests will run here when frontend is implemented"
          echo "Tests will be run with coverage enabled and uploaded to Codecov"
          echo "Skipping for now as no frontend exists yet"
          echo "percentage=0" >> $GITHUB_OUTPUT

  frontend-integration-tests:
    name: Frontend ‚Üí Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Placeholder
        run: |
          echo "Frontend integration tests will run here when frontend is implemented"
          echo "Tests will be run with coverage enabled and uploaded to Codecov"
          echo "Skipping for now as no frontend exists yet"

  # ============================================
  # Coverage Summary (Updates PR Description)
  # ============================================

  coverage-summary:
    name: Coverage ‚Üí Update PR
    runs-on: ubuntu-latest
    needs:
      - backend-unit-tests
      - backend-integration-tests
      - frontend-unit-tests
    if: always() && github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Update PR description with coverage
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const backendUnitCoverage = '${{ needs.backend-unit-tests.outputs.coverage || 'N/A' }}';
            const backendIntegrationCoverage = '${{ needs.backend-integration-tests.outputs.coverage || 'N/A' }}';
            const frontendCoverage = '${{ needs.frontend-unit-tests.outputs.coverage || 'N/A' }}';

            try {
              // Get current PR
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });

              // Create coverage section with Codecov badge
              const coverageSection = `
              ## üìä Test Coverage

              [![codecov](https://codecov.io/gh/${context.repo.owner}/${context.repo.repo}/branch/${context.payload.pull_request.head.ref}/graph/badge.svg)](https://codecov.io/gh/${context.repo.owner}/${context.repo.repo}/branch/${context.payload.pull_request.head.ref})

              | Component | Coverage |
              |-----------|----------|
              | Backend Unit Tests | ${backendUnitCoverage}% |
              | Backend Integration Tests | ${backendIntegrationCoverage}% |
              | Frontend | ${frontendCoverage === '0' ? 'N/A (not implemented)' : frontendCoverage + '%'} |

              _Updated: ${new Date().toISOString()}_

              ---
              `;

              let body = pr.data.body || '';

              // Remove existing coverage section if present
              const coverageRegex = /## üìä Test Coverage[\s\S]*?---\n/g;
              body = body.replace(coverageRegex, '');

              // Add new coverage section at the end
              body = body.trim() + '\n\n' + coverageSection;

              // Update PR description
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: body
              });

              console.log('‚úÖ PR description updated with coverage information');
            } catch (error) {
              // Gracefully handle permission errors (e.g., from forks)
              if (error.status === 403) {
                console.log('‚ö†Ô∏è Insufficient permissions to update PR description (likely from fork)');
                console.log(`Coverage: Backend Unit ${backendUnitCoverage}%, Backend Integration ${backendIntegrationCoverage}%, Frontend ${frontendCoverage}%`);
              } else {
                throw error;
              }
            }

  # ============================================
  # System Tests
  # ============================================

  system-tests:
    name: System Tests
    runs-on: ubuntu-latest
    needs:
      - backend-unit-tests
      - backend-integration-tests
      - frontend-unit-tests
      - frontend-integration-tests
    steps:
      - name: Placeholder for system tests
        run: |
          echo "System tests will run here once containers are set up"
          echo "This job ensures all component tests pass before running end-to-end tests"

  # ============================================
  # Summary
  # ============================================

  ci-summary:
    name: ‚úÖ CI Summary
    runs-on: ubuntu-latest
    needs:
      - backend-unit-tests
      - backend-integration-tests
      - frontend-unit-tests
      - frontend-integration-tests
      - system-tests
    if: always()
    steps:
      - name: Check all jobs
        run: |
          echo "## üîç Test Results Summary"
          echo ""
          echo "### Backend"
          echo "- Unit Tests: ${{ needs.backend-unit-tests.result }}"
          echo "- Integration Tests: ${{ needs.backend-integration-tests.result }}"
          echo ""
          echo "### Frontend"
          echo "- Unit Tests: ${{ needs.frontend-unit-tests.result }}"
          echo "- Integration Tests: ${{ needs.frontend-integration-tests.result }}"
          echo ""
          echo "### System Tests"
          echo "- System Tests: ${{ needs.system-tests.result }}"
          echo ""

          if [[ "${{ needs.backend-unit-tests.result }}" != "success" ]] || \
             [[ "${{ needs.backend-integration-tests.result }}" != "success" ]]; then
            echo "‚ùå One or more test jobs failed"
            exit 1
          fi

          echo "‚úÖ All required CI jobs passed!"
